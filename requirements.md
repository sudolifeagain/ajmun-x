# **オフラインイベント入退場管理システム 要件定義書**

## **1\. プロジェクト概要**

* **目的:** 300人規模・4日間開催のオフラインイベントにおいて、Discordアカウントと連携したQRコードによる高速かつスムーズな出席管理を行う。  
* **コアコンセプト:** 「行列を作らない」「最小権限でセキュアに」「サーバー/ロールごとの視覚的判別」。
* **サーバー構成:** 
  * **会議サーバー（6つ）:** 各会議ごとに1サーバー。それぞれ「参加者」「会議運営者」「スタッフ」が所属。
  * **運営サーバー（1つ）:** 全会議の「会議運営者」と「スタッフ」が所属する中央管理用サーバー。
  * 各サーバーにBotは参加可能であり、どのサーバーからでも参加者情報を取得可能とする。
* **ユーザー属性（3種類）:**
  * **参加者:** 各会議の一般参加者。会議サーバーのみに所属。
  * **会議運営者:** 特定会議の運営担当。**運営サーバーのロール**で判別。
  * **スタッフ:** イベント全体のスタッフ。**運営サーバーのロール**で判別。
* **属性の優先順位（重複時）:** 基本的に1人1属性だが、例外的に複数属性を持つ場合は以下の優先順位で判定する：
  1. **スタッフ** （最優先）
  2. **会議運営者**
  3. **参加者**
* **出席記録の扱い:** 優先順位の高い属性でログに記録するが、所属する全会議において「出席済み」としてカウントする。
* **イベント期間:**
  * **開催期間:** 2024年12月27日〜12月30日（日本時間）
  * **QRコード発行開始:** 2024年12月23日（日本時間）から事前発行可能
* **サーバーアイコン未設定時:** アイコンが設定されていないサーバーの場合、**デフォルト色**で背景を表示する。
* **複数会議サーバー所属時の挙動:** 参加者が複数の会議サーバーに所属している場合、**すべての所属サーバーのアイコン**をスキャナー画面に並列して表示する。
* **設定変更:** 対象となる会議サーバーや管理ロールIDは、初期値は固定（シードデータ）で設定するが、**最上位権限を持つ管理者のみ実行可能なSlash Command**経由で後から追加・変更可能とする。
* **実行環境:** 
  * Oracle Cloud Infrastructure (OCI) 無料枠の**ARMインスタンス**（4 OCPU / 24GB RAM）を使用。
  * **構成:** DB（SQLite or PostgreSQL）・Webサーバー・Discord Bot を**同一インスタンスに同居**させる。
  * **ドメイン:** 独自ドメイン保有済み。Cloudflare経由でHTTPS化。

## **2\. ユーザーストーリー (User Stories)**

### **【参加者 (User)】**

* **US-01 (安心とプライバシー):** 私は、Discord連携時に「どのサーバーに入っているか」というプライベートな情報を渡すことなく、**ユーザーID（身元）のみの最小権限**でログインしたい。  
* **US-02 (事前確認):** 私は、QRコード発行画面で「自分のアイコン」や「イベントサーバーでのニックネーム」を確認し、システムが正しく自分を認識していることを確認したい。  
* **US-03 (オフライン対策):** 私は、会場の電波状況が悪くても入場できるよう、**事前に保存したスクリーンショット画像**を使って受付を済ませたい。  
* **US-04 (4日間共通):** 私は、期間中に何度もQRコードを出し直すことなく、1枚の画像で4日間すべての受付を通過したい。

### **【受付スタッフ (Staff)】**

* **US-05 (直感的な判別):** 私は、QRコードをスキャンした際、画面の文字を読むのではなく、**「各サーバーごとのアイコン（背景画像）」と「音」だけ**で、その参加者の所属（Aチーム/Bチーム/VIPなど）を瞬時に判断したい。  
* **US-06 (ハンズフリースキャン):** 私は、スキャンごとにボタンを押す操作をしたくない。カメラをかざし続けるだけで連続して読み取れる状態で、行列を止めずにさばきたい。  
* **US-07 (トラブルスルー):** 私は、既に受付済みの人が誤って再度かざした場合でも、エラー音を聞き流し、その人を止めることなくスムーズに入場させたい。

### **【管理者 (Admin)】**

* **US-08 (セキュリティ):** 私は、システム運用に使うDiscord Botに管理者権限を与えず、万が一のトークン流出時でもサーバーが荒らされない状態を維持したい。  
* **US-09 (出席状況把握):** 私は、会議ごとに「現在誰が来ているか」「誰がまだ来ていないか」をリアルタイムで確認し、運営判断に活用したい。  
* **US-10 (アクセス制限):** 私は、スタッフ用スキャナーサイトへのアクセスを **Cloudflare Access** で保護し、許可されたメールアドレスを持つスタッフのみがアクセスできる安全な状態にしたい。

## **3\. 機能要件 (Functional Requirements)**

### **3-1. 参加者用 Webアプリケーション (Frontend \- User)**

1. **Discord OAuth2 認証**  
   * **スコープ:** identify のみを使用（guildsスコープは使用禁止）。  
   * **目的:** ユーザーのDiscord ID、デフォルトアバター、グローバル名の取得。  
2. **参加資格・属性判定 (Bot検証)**  
   * バックエンド経由でDiscord Bot APIを使用し、特定のサーバー（Guild）に対象ユーザーが存在するか確認する。  
   * **取得データ:** サーバー内ニックネーム、サーバーごとのアバター画像（あれば）、**サーバー（Guild）のアイコン画像**、**保持しているロールID一覧**。  
3. **属性決定**
   * ロール所持状況に基づき、ユーザーの属性（参加者/会議運営者/スタッフ）を決定してDBにキャッシュする。
   * **入場制限は行わない:** すべての認証済みユーザーにQRコードを発行する。  
4. **静的QRコード生成**  
   * イベント期間中不変のトークンを発行する。  
   * トークンは推測不可能なハッシュ値とし、署名を付与する。  
5. **キャッシュ保存**  
   * APIレート制限回避と高速表示のため、取得したニックネーム・アイコンURL・テーマカラーを自社DBに保存する。

### **3-2. 受付スタッフ用 スキャナー (Frontend - Staff)**

1.  **連続スキャンモード (Continuous Scanning)**
    *   カメラを常時起動し、QRコードを検知したら即座に検証リクエストを送る。
    *   結果表示後、1.5〜2.0秒で自動的にスキャン待機状態へリセットされること。
2.  **視覚・聴覚フィードバック (UX)**
    *   **判定OK:**
        *   画面全体に「サーバーのアイコン（Guild Icon）」を背景として大きく表示する。**（複数所属の場合は分割表示または並列表示）**
        *   DBに保存された「サーバー内ニックネーム」と「アイコン」を大きく表示する。
        *   属性に応じた**バイブレーションパターン**（短い振動1回）で通知する。
    *   **重複（当日済）:**
        *   画面を黄色にする。「本日入場済み」と表示。
        *   **バイブレーションパターン**（短い振動2回）で通知するが、次のスキャンをブロックしない。
    *   **エラー（権限なし）:**
        *   画面を黒/赤にする。
        *   **バイブレーションパターン**（長い振動1回）で通知する。
3.  **Zero Trust アクセス制御 (Cloudflare Access)**
    *   スタッフ用スキャナーのURL（ルート全体）を Cloudflare Access で保護する。
    *   **認証方式:** メールアドレス認証（OTP）または 指定のIdP連携を使用。
    *   **ポリシー:** 事前に登録されたスタッフのメールアドレス（またはドメイン）からのアクセスのみを許可する。
    *   アプリケーション側でのログイン機能実装は不要とする。

### **3-3. バックエンド・システム (Backend)**

1.  **Bot権限構成**
    *   Discord Developer Portalにて Server Members Intent を有効化する。
    *   Discordサーバー上のBotロール権限は「チャンネルを見る (View Channels)」のみとする（管理者権限NG）。
2.  **出席記録ロジック**
    *   DBへの記録は User\_ID + Date (YYYY-MM-DD) のユニーク制約を設ける。
    *   スキャンリクエストに対し、以下のステータスを高速に返す。
        *   200 OK: 初回入場（DB書き込み成功）。
        *   200 OK (Duplicate): 当日2回目（DB書き込みスキップ、フロントでは黄色表示）。
        *   403 Forbidden: トークン無効またはロール剥奪済み（※ロール状態はQR発行時点のものを基準とし、リアルタイムの剥奪反映は行わない）。

### **3-4. 管理者用 Discord Bot スラッシュコマンド**

1.  **/attendance status [会議名|all] [属性?]**
    *   指定した会議（または全会議）の出席状況サマリーを表示（出席者数/未出席者数）。
    *   オプションで属性（参加者/会議運営者/スタッフ）を指定して絞り込み可能。
2.  **/attendance present [会議名|all] [属性?]**
    *   指定した会議（または全会議）の「本日出席済み」ユーザー一覧を表示。
    *   オプションで属性を指定して絞り込み可能。
3.  **/attendance absent [会議名|all] [属性?]**
    *   指定した会議（または全会議）の「本日未出席」ユーザー一覧を表示。
    *   オプションで属性を指定して絞り込み可能。
    *   **母数:** 指定した会議サーバーのメンバー、または指定した属性の保持者。
4.  **権限制御**
    *   管理者が事前に指定した**複数のロール**のいずれかを保持しているユーザーのみ実行可能。
    *   許可ロールはDBで管理し、最上位管理者用コマンドで追加・削除可能とする。
5.  **/system config [key] [value]** (最上位権限のみ)
    *   会議サーバーIDや管理用ロールIDの登録・変更を行う。

## **4\. 非機能要件 (Non-Functional Requirements)**

### **4-1. パフォーマンス・可用性**

*   **レスポンスタイム:** QR検知から判定結果のUI表示まで **1秒以内** であること（外部APIへのリアルタイム問い合わせは行わず、DBキャッシュを参照すること）。
*   **オフライン耐性（ユーザー）:** 参加者端末はオフライン（機内モード等）でも、保存済み画像の提示のみで運用可能であること。
*   **ネットワーク依存（スタッフ）:** スタッフ端末は常時インターネット接続が必要。

### **4-2. セキュリティ・プライバシー**

*   **最小権限の原則:** ユーザーのOAuthトークンはログイン処理直後に破棄し、保持しない。Botトークンは環境変数で厳重に管理する。
*   **データライフサイクル:** イベント終了後、収集した個人情報（ニックネーム、アイコンURL、Discord IDの紐付け）は速やかにDBから削除可能な設計にすること。
*   **なりすまし対策:** 同一QRコードによる「同日の」複数回入場はログ上で重複扱いとし、カウントしない（運用上は通すが、人数集計の正確性を保つ）。
*   **管理画面保護:** スタッフ用画面および管理APIエンドポイントは Cloudflare Access 下に配置し、未認証のリクエストをネットワークエッジで遮断すること。

### **4-3. ユーザビリティ**

*   **屋外視認性:** スキャナー画面は高コントラスト配色を使用し、直射日光下や暗所でも「表示（アイコンや色）」が判別できること。
*   **操作不要:** スタッフはいかなるボタン操作も行わず、ただ画面を見る・音を聞くだけで業務が完結すること。

## **5\. データモデル設計案**

### **Users (ユーザー基本情報)**

| Column | Type | Description |
| :---- | :---- | :---- |
| discord\_user\_id | String (PK) | Snowflake ID |
| qr\_token | String (Unique) | 署名付きハッシュトークン |
| global\_name | String | Discordグローバル名 |
| default\_avatar\_url | String | デフォルトアバターURL |
| primary\_attribute | Enum | 参加者/会議運営者/スタッフ（優先順位で決定） |
| created\_at | Datetime | 登録日時 |

### **Guilds (サーバー情報)**

| Column | Type | Description |
| :---- | :---- | :---- |
| guild\_id | String (PK) | Discord Guild Snowflake ID |
| guild\_name | String | サーバー名 |
| guild\_icon\_url | String (Nullable) | サーバーアイコンURL（未設定時はNULL） |
| default\_color | String | アイコン未設定時のデフォルト色 (#FF0000等) |
| is\_operation\_server | Boolean | 運営サーバーフラグ |
| is\_target\_guild | Boolean | 会議サーバーとして有効かどうか |

### **System\_Config (システム設定)**

| Column | Type | Description |
| :---- | :---- | :---- |
| key | String (PK) | 設定キー (例: `staff_role_id`, `admin_role_id`) |
| value | String | 設定値 (JSON文字列やカンマ区切りID等) |
| description | String | 説明 |

### **User\_Guild\_Memberships (ユーザー×サーバー所属)**

| Column | Type | Description |
| :---- | :---- | :---- |
| id | Integer (PK) | Auto Increment |
| discord\_user\_id | String (FK) | Usersテーブル参照 |
| guild\_id | String (FK) | Guildsテーブル参照 |
| nickname | String (Nullable) | サーバー内ニックネーム |
| avatar\_url | String (Nullable) | サーバー固有アバターURL |
| role\_ids | JSON/Array | 保持しているロールID一覧 |

### **Attendance\_Logs (出席ログ)**

| Column | Type | Description |
| :---- | :---- | :---- |
| id | Integer (PK) | Auto Increment |
| discord\_user\_id | String (FK) | Usersテーブル参照 |
| primary\_guild\_id | String (FK) | 主所属サーバー（表示に使用） |
| attribute | Enum | 記録時の属性（参加者/会議運営者/スタッフ） |
| check\_in\_date | Date | 入場日 (ユニーク制約: user\_id + date) |
| check\_in\_timestamp | Datetime | 入場日時 |
